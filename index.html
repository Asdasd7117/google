<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Flutter Project Editor - Netlify</title>

    <!-- CSS CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/theme/eclipse.min.css">

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            direction: rtl;
            background-color: #f9f9f9;
        }
        h2 {
            color: #333;
        }
        #structureText {
            width: 100%;
            height: 150px;
            resize: vertical;
            border: 1px solid #ccc;
            padding: 10px;
            font-family: monospace;
        }
        ul {
            list-style: none;
            padding-right: 20px;
        }
        button {
            padding: 8px 15px;
            margin: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #editorDiv {
            display: none;
            margin-top: 20px;
            background-color: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .CodeMirror {
            border: 1px solid #ccc;
            height: 400px;
            direction: ltr;
        }
        .empty-file {
            color: red;
        }
        #loading {
            display: none;
            color: #007bff;
            font-weight: bold;
            margin-top: 10px;
        }
        #fileTree {
            margin-top: 10px;
        }
        .file-tree-item {
            margin: 5px 0;
        }
        .file-tree-item button {
            background: none;
            color: #007bff;
            border: none;
            padding: 0;
            cursor: pointer;
        }
        .file-tree-item button:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

<h2>إدخال هيكل المشروع نصياً</h2>
<textarea id="structureText" placeholder="الصق هنا الهيكل النصي للمشروع..."></textarea><br>
<label><input type="checkbox" id="addAndroidFiles" checked> إضافة ملفات Android الافتراضية</label><br>
<button onclick="createProject()">إنشاء المشروع</button>

<h2>هيكل المشروع</h2>
<div id="fileTree"></div>

<h2>تحرير الملف</h2>
<div id="editorDiv">
    <p>الملف الحالي: <span id="currentFile"></span></p>
    <textarea id="fileEditor"></textarea><br>
    <button onclick="saveFile()">حفظ التعديلات</button>
</div>

<h2>ضغط المشروع</h2>
<button onclick="downloadZip()">إنشاء ZIP وتحميل</button>
<button onclick="buildApk()">إنشاء APK وتحميل</button>
<div id="loading">جارٍ إنشاء الملف...</div>

<!-- JS Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/dart/dart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/groovy/groovy.min.js"></script>

<script>
let project = {};
let currentFile = '';
let editor = CodeMirror.fromTextArea(document.getElementById("fileEditor"), {
    lineNumbers: true,
    mode: "dart",
    theme: "eclipse",
    direction: "ltr"
});

// ==== إنشاء المشروع من النص ====
function createProject() {
    const text = document.getElementById('structureText').value;
    const lines = text.split('\n');
    project = {};
    const stack = [{ obj: project, level: -1 }];

    lines.forEach(line => {
        if (!line.trim()) return;
        const spaces = line.match(/^\s*/)[0].length;
        const name = line.trim();
        while (stack.length && stack[stack.length - 1].level >= spaces) stack.pop();
        const parent = stack[stack.length - 1].obj;
        if (name.endsWith('/') || !name.includes('.')) parent[name.replace(/\/$/, '')] = {};
        else parent[name] = '';
        if (name.endsWith('/') || !name.includes('.')) stack.push({ obj: parent[name.replace(/\/$/, '')], level: spaces });
    });

    // إضافة ملفات Android الافتراضية إذا اختار المستخدم
    if (document.getElementById('addAndroidFiles').checked) {
        addDefaultAndroidFiles();
        alert("✅ تم إنشاء مجلد android مع ملفات البناء الحديثة بناءً على بنية التطبيق.\n⚠️ تذكر: تحتاج لإضافة gradle-wrapper.jar يدوياً داخل android/gradle/wrapper/ من https://services.gradle.org/");
    } else {
        alert("✅ تم إنشاء المشروع بنجاح!");
    }

    renderTree();
}

// ==== عرض الشجرة مع تمييز الملفات الفارغة ====
function renderTree() {
    const container = document.getElementById('fileTree');
    container.innerHTML = '';
    function buildTree(obj, path = '') {
        const ul = document.createElement('ul');
        for (const key in obj) {
            const li = document.createElement('li');
            li.classList.add('file-tree-item');
            const fullPath = path + key;
            if (typeof obj[key] === 'object') {
                const subUl = buildTree(obj[key], fullPath + '/');
                if (subUl.children.length === 0) li.classList.add('empty-file');
                li.innerHTML = `<strong>${key}/</strong>`;
                li.appendChild(subUl);
            } else {
                const btn = document.createElement('button');
                btn.textContent = key;
                if (obj[key].trim() === '') btn.style.color = 'red';
                btn.onclick = () => openFile(fullPath);
                li.appendChild(btn);
            }
            ul.appendChild(li);
        }
        return ul;
    }
    container.appendChild(buildTree(project));
}

// ==== فتح الملف في المحرر ====
function openFile(path) {
    currentFile = path;
    document.getElementById('editorDiv').style.display = 'block';
    document.getElementById('currentFile').textContent = path;

    const parts = path.split('/');
    let obj = project;
    for (let i = 0; i < parts.length; i++) obj = obj[parts[i]];

    editor.setValue(obj || '');
    if (path.endsWith('.kt')) editor.setOption('mode', 'text/x-kotlin');
    else if (path.endsWith('.dart')) editor.setOption('mode', 'dart');
    else if (path.endsWith('.xml')) editor.setOption('mode', 'xml');
    else if (path.endsWith('.gradle')) editor.setOption('mode', 'groovy');
    else editor.setOption('mode', 'javascript');
}

// ==== حفظ الملف ====
function saveFile() {
    const parts = currentFile.split('/');
    let obj = project;
    for (let i = 0; i < parts.length - 1; i++) obj = obj[parts[i]];
    obj[parts[parts.length - 1]] = editor.getValue();
    alert('✅ تم حفظ التعديلات!');
    renderTree();
}

// ==== تحديث جميع الملفات المفتوحة قبل ZIP ====
function updateAllFilesInProject(obj, path = '') {
    for (const key in obj) {
        if (typeof obj[key] === 'object') {
            updateAllFilesInProject(obj[key], path + key + '/');
        } else {
            if (currentFile === path + key) {
                obj[key] = editor.getValue();
            }
        }
    }
}

// ==== إنشاء ZIP لجميع الملفات والمجلدات ====
function downloadZip() {
    try {
        updateAllFilesInProject(project);
        const zip = new JSZip();

        function addFiles(obj, folder) {
            for (const key in obj) {
                if (typeof obj[key] === 'object') {
                    const sub = folder.folder(key);
                    addFiles(obj[key], sub);
                } else {
                    folder.file(key, obj[key] || '');
                }
            }
        }

        addFiles(project, zip);
        document.getElementById('loading').style.display = 'block';

        zip.generateAsync({ type: "blob" }).then(function (content) {
            const a = document.createElement('a');
            const url = URL.createObjectURL(content);
            a.href = url;
            a.download = "project.zip";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            document.getElementById('loading').style.display = 'none';
            alert('✅ تم إنشاء ملف ZIP وتحميله بنجاح!');
        }).catch(function (error) {
            console.error('خطأ أثناء إنشاء ZIP:', error);
            alert('❌ فشل إنشاء ملف ZIP. تحقق من وحدة التحكم لمزيد من التفاصيل.');
            document.getElementById('loading').style.display = 'none';
        });
    } catch (error) {
        console.error('خطأ عام:', error);
        alert('❌ حدث خطأ أثناء إنشاء الملف المضغوط. تحقق من وحدة التحكم.');
        document.getElementById('loading').style.display = 'none';
    }
}

// ==== إنشاء APK (توجيه يدوي أو عبر API لاحقًا) ====
function buildApk() {
    alert('⚠️ إنشاء ملف APK يتطلب بيئة Flutter SDK وAndroid SDK حديثة. اتبع الخطوات التالية:\n1. انقر على "إنشاء ZIP وتحميل" لتحميل المشروع.\n2. فك ضغط الملف على جهازك.\n3. أضف ملف gradle-wrapper.jar إلى android/gradle/wrapper/ من https://services.gradle.org/.\n4. تأكد من تثبيت Flutter SDK (إصدار 3.24 أو أحدث) وAndroid SDK مع API 36.\n5. افتح طرفية في مجلد المشروع وشغّل الأمر:\n   flutter build apk --release\nسيتم إنشاء APK في build/app/outputs/flutter-apk/app-release.apk\n\n📝 ملاحظة: إذا كنت بحاجة إلى دعم تلقائي لإنشاء APK، يجب إعداد خادم مع API.');
}

// ==== استخراج اسم التطبيق واسم الحزمة من pubspec.yaml ====
function extractAppInfo() {
    let projectName = "MyFlutterApp";
    let packageName = "com.example.myflutterapp";

    if (project['pubspec.yaml']) {
        const pubspec = project['pubspec.yaml'];
        const nameMatch = pubspec.match(/name:\s*(\w+)/);
        const packageMatch = pubspec.match(/package:\s*([\w.]+)/);
        if (nameMatch) projectName = nameMatch[1];
        if (packageMatch) packageName = packageMatch[1];
    } else {
        const rootKeys = Object.keys(project);
        if (rootKeys.length > 0 && rootKeys[0] !== 'android') {
            projectName = rootKeys[0];
            packageName = `com.example.${projectName.toLowerCase()}`;
        }
    }

    return { projectName, packageName };
}

// ==== إضافة ملفات Android الافتراضية بناءً على بنية التطبيق ====
function addDefaultAndroidFiles() {
    if (!project['android']) project['android'] = {};

    const { projectName, packageName } = extractAppInfo();

    // ملف build.gradle الرئيسي
    project['android']['build.gradle'] = 
`buildscript {
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:8.13.0'
        classpath 'org.jetbrains.kotlin:kotlin-gradle-plugin:2.2.10'
    }
}
allprojects {
    repositories {
        google()
        mavenCentral()
    }
}`;

    // ملف settings.gradle
    project['android']['settings.gradle'] = 
`pluginManagement {
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
    plugins {
        id 'com.android.application' version '8.13.0' apply false
        id 'org.jetbrains.kotlin.android' version '2.2.10' apply false
    }
}
rootProject.name = '${projectName}'
include ':app'`;

    // ملف gradle-wrapper.properties
    project['android']['gradle'] = { 'wrapper': {
        'gradle-wrapper.properties':
`distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\\://services.gradle.org/distributions/gradle-8.13-bin.zip
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists`,
        'gradle-wrapper.jar': '' // يحتاج تنزيل يدوي
    } };

    // ملف gradlew
    project['android']['gradlew'] = 
`#!/usr/bin/env sh
DIR="$( cd "$( dirname "$0" )" && pwd )"
exec "$DIR/gradle/wrapper/gradle-wrapper.jar" "$@"`;

    // ملف gradlew.bat
    project['android']['gradlew.bat'] = 
`@ECHO OFF
SET DIR=%~dp0
"%DIR%\\gradle\\wrapper\\gradle-wrapper.jar" %*`;

    // ملفات app
    project['android']['app'] = {
        'build.gradle':
`plugins {
    id 'com.android.application'
    id 'org.jetbrains.kotlin.android'
}

android {
    namespace '${packageName}'
    compileSdk 36

    defaultConfig {
        applicationId '${packageName}'
        minSdk 21
        targetSdk 36
        versionCode 1
        versionName "1.0"

        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
    }

    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }

    kotlinOptions {
        jvmTarget = '17'
    }
}

dependencies {
    implementation 'androidx.core:core:1.13.1'
    implementation 'androidx.appcompat:appcompat:1.7.1'
    implementation 'com.google.android.material:material:1.12.0'
    testImplementation 'junit:junit:4.13.2'
    androidTestImplementation 'androidx.test.ext:junit:1.2.1'
    androidTestImplementation 'androidx.test.espresso:espresso-core:3.6.1'
}`,
        'proguard-rules.pro':
`# Add project specific ProGuard rules here.
# By default, the flags in this file are appended to flags specified
# in the Android SDK tools proguard folder.
-keep class io.flutter.** { *; }
-keep class androidx.** { *; }
-dontwarn io.flutter.**
-dontwarn androidx.**
`,
        'src': {
            'main': {
                'AndroidManifest.xml':
`<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    package="${packageName}">

    <!-- الأذونات الأساسية المطلوبة لتطبيق Flutter -->
    <uses-permission android:name="android.permission.INTERNET" />

    <application
        android:label="${projectName}"
        android:icon="@mipmap/ic_launcher"
        android:allowBackup="true"
        android:supportsRtl="true"
        android:theme="@style/Theme.AppCompat.Light.NoActionBar"
        tools:targetApi="36">

        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:configChanges="orientation|keyboardHidden|screenSize|locale|layoutDirection"
            android:windowSoftInputMode="adjustResize">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>

        <!-- تحديد توافق Flutter مع Android -->
        <meta-data
            android:name="flutterEmbedding"
            android:value="2" />
    </application>

</manifest>`,
                'java': {
                    'com': { 'example': { [projectName.toLowerCase()]: {
                        'MainActivity.kt':
`package ${packageName}

import io.flutter.embedding.android.FlutterActivity

class MainActivity : FlutterActivity() {
}`
                    } } }
                },
                'res': {
                    'mipmap': {
                        'ic_launcher.png': '' // يحتاج إلى إضافة أيقونة يدويًا
                    },
                    'values': {
                        'styles.xml':
`<?xml version="1.0" encoding="utf-8"?>
<resources>
    <style name="AppTheme" parent="Theme.AppCompat.Light.NoActionBar">
        <!-- Customize your theme here -->
    </style>
</resources>`
                    }
                }
            }
        }
    };

    // إضافة ملف pubspec.yaml إذا لم يكن موجودًا
    if (!project['pubspec.yaml']) {
        project['pubspec.yaml'] =
`name: ${projectName.toLowerCase()}
description: A new Flutter project.
version: 1.0.0+1
environment:
  sdk: '>=3.5.0 <4.0.0'
dependencies:
  flutter:
    sdk: flutter
  cupertino_icons: ^1.0.8
flutter:
  uses-material-design: true
`;
    }

    // إضافة ملف main.dart إذا لم يكن موجودًا
    if (!project['lib']) project['lib'] = {};
    if (!project['lib']['main.dart']) {
        project['lib']['main.dart'] =
`import 'package:flutter/material.dart';

void main() {
  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: '${projectName}',
      theme: ThemeData(
        primarySwatch: Colors.blue,
        useMaterial3: true,
      ),
      home: Scaffold(
        appBar: AppBar(title: Text('${projectName}')),
        body: Center(child: Text('Hello, Flutter!')),
      ),
    );
  }
}
`;
    }
}
</script>
</body>
</html>
