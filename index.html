<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Flutter Project Editor - Netlify</title>

<!-- CSS CodeMirror -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/theme/eclipse.min.css">

<style>
body { font-family: Arial; margin:20px; }
#structureText { width:100%; height:150px; }
ul { list-style:none; padding-left:20px; }
button { padding:5px 10px; margin-top:5px; margin-bottom:5px; }
#editorDiv { display:none; margin-top:10px; }
.CodeMirror { border:1px solid #ccc; height:300px; direction:ltr; }
.empty-file { color:red; }
</style>
</head>
<body>

<h2>إدخال هيكل المشروع نصياً</h2>
<textarea id="structureText" placeholder="الصق هنا الهيكل النصي للمشروع..."></textarea><br>
<label><input type="checkbox" id="addAndroidFiles"> إضافة ملفات Android الافتراضية</label><br>
<button onclick="createProject()">إنشاء المشروع</button>

<h2>هيكل المشروع</h2>
<div id="fileTree"></div>

<h2>تحرير الملف</h2>
<div id="editorDiv">
  <p>الملف: <span id="currentFile"></span></p>
  <textarea id="fileEditor"></textarea><br>
  <button onclick="saveFile()">حفظ التعديلات</button>
</div>

<h2>ضغط المشروع</h2>
<button onclick="downloadZip()">إنشاء ZIP وتحميل</button>

<!-- JS Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.11.0/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/dart/dart.min.js"></script>

<script>
let project = {};
let currentFile = '';
let editor = CodeMirror.fromTextArea(document.getElementById("fileEditor"), {
    lineNumbers: true,
    mode: "dart",
    theme: "eclipse",
    direction: "ltr"
});

// ==== إنشاء المشروع من النص ====
function createProject() {
    const text = document.getElementById('structureText').value;
    const lines = text.split('\n');
    project = {};
    const stack = [{obj: project, level:-1}];

    lines.forEach(line=>{
        if(!line.trim()) return;
        const spaces = line.match(/^\s*/)[0].length;
        const name = line.trim();
        while(stack.length && stack[stack.length-1].level >= spaces) stack.pop();
        const parent = stack[stack.length-1].obj;
        if(name.endsWith('/') || !name.includes('.')) parent[name.replace(/\/$/,'')] = {};
        else parent[name] = '';
        if(name.endsWith('/') || !name.includes('.')) stack.push({obj: parent[name.replace(/\/$/,'')], level:spaces});
    });

    // إضافة ملفات Android الافتراضية إذا اختار المستخدم
    if(document.getElementById('addAndroidFiles').checked) {
        addDefaultAndroidFiles();
        alert("✅ تم إنشاء مجلد android مع ملفات البناء.\n⚠️ تذكر: تحتاج لإضافة gradle-wrapper.jar يدوياً داخل android/gradle/wrapper/");
    }

    renderTree();
}

// ==== عرض الشجرة مع تمييز الملفات الفارغة ====
function renderTree() {
    const container = document.getElementById('fileTree');
    container.innerHTML = '';
    function buildTree(obj, path='') {
        const ul = document.createElement('ul');
        for(const key in obj) {
            const li = document.createElement('li');
            const fullPath = path + key;
            if(typeof obj[key]==='object') {
                const subUl = buildTree(obj[key], fullPath + '/');
                if(subUl.children.length === 0) li.classList.add('empty-file');
                li.innerHTML = `<strong>${key}/</strong>`;
                li.appendChild(subUl);
            } else {
                const btn = document.createElement('button');
                btn.textContent = key;
                if(obj[key].trim()==='') btn.style.color='red';
                btn.onclick = ()=>openFile(fullPath);
                li.appendChild(btn);
            }
            ul.appendChild(li);
        }
        return ul;
    }
    container.appendChild(buildTree(project));
}

// ==== فتح الملف في المحرر ====
function openFile(path) {
    currentFile = path;
    document.getElementById('editorDiv').style.display='block';
    document.getElementById('currentFile').textContent = path;

    const parts = path.split('/');
    let obj = project;
    for(let i=0;i<parts.length;i++) obj = obj[parts[i]];

    editor.setValue(obj);
    if(path.endsWith('.kt')) editor.setOption('mode','text/x-kotlin');
    else if(path.endsWith('.dart')) editor.setOption('mode','dart');
    else editor.setOption('mode','javascript');
}

// ==== حفظ الملف ====
function saveFile() {
    const parts = currentFile.split('/');
    let obj = project;
    for(let i=0;i<parts.length-1;i++) obj = obj[parts[i]];
    obj[parts[parts.length-1]] = editor.getValue();
    alert('تم حفظ التعديلات!');
    renderTree();
}

// ==== تحديث الملف الحالي من CodeMirror قبل ZIP ====
function updateCurrentFileInProject() {
    if(!currentFile) return;
    const parts = currentFile.split('/');
    let obj = project;
    for(let i=0;i<parts.length-1;i++) obj = obj[parts[i]];
    obj[parts[parts.length-1]] = editor.getValue();
}

// ==== إنشاء ZIP لجميع الملفات والمجلدات حتى لو فارغة أو ملف واحد ====
function downloadZip() {
    updateCurrentFileInProject(); // ✅ تحديث آخر التعديلات
    const zip = new JSZip();

    function addFiles(obj, folder) {
        for(const key in obj) {
            if(typeof obj[key]==='object') {
                const sub = folder.folder(key);
                addFiles(obj[key], sub);
            } else {
                folder.file(key, obj[key] || '');
            }
        }
    }

    addFiles(project, zip);

    zip.generateAsync({type:"blob"}).then(function(content){
        const a = document.createElement('a');
        a.href = URL.createObjectURL(content);
        a.download = "project.zip";
        a.click();
    });
}

// ==== إضافة ملفات Android الافتراضية + gradlew ====
function addDefaultAndroidFiles() {
    if(!project['android']) project['android'] = {};

    let projectName = "MyFlutterApp";
    const rootKeys = Object.keys(project);
    if(rootKeys.length > 0) projectName = rootKeys[0];

    const packageName = "com.example." + projectName.toLowerCase();

    project['android']['build.gradle'] = 
`buildscript {
    repositories { google(); mavenCentral() }
    dependencies { classpath 'com.android.tools.build:gradle:7.4.1' }
}
allprojects { repositories { google(); mavenCentral() } }`;

    project['android']['settings.gradle'] = `rootProject.name = '${projectName}'`;

    project['android']['gradle'] = { 'wrapper': {
        'gradle-wrapper.properties':
`distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\\://services.gradle.org/distributions/gradle-7.5-bin.zip
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists`,
        'gradle-wrapper.jar': '' // يحتاج تنزيل يدوي
    } };

    project['android']['gradlew'] =
`#!/usr/bin/env sh
DIR="$( cd "$( dirname "$0" )" && pwd )"
exec "$DIR/gradle/wrapper/gradle-wrapper.jar" "$@"`;

    project['android']['gradlew.bat'] =
`@ECHO OFF
SET DIR=%~dp0
"%DIR%\\gradle\\wrapper\\gradle-wrapper.jar" %*`;

    project['android']['app'] = {
        'build.gradle':
`apply plugin: 'com.android.application'
android {
    compileSdkVersion 33
    defaultConfig {
        applicationId "${packageName}"
        minSdkVersion 21
        targetSdkVersion 33
        versionCode 1
        versionName "1.0"
    }
}
dependencies {}`,
        'src': {
            'main': {
                'AndroidManifest.xml':
`<manifest package="${packageName}">
<application android:label="${projectName}"></application>
</manifest>`,
                'java': {
                    'com': { 'example': { [projectName]: {
                        'MainActivity.kt':
`package com.example.${projectName}
import android.os.Bundle
import io.flutter.embedding.android.FlutterActivity
class MainActivity: FlutterActivity() { 
    override fun onCreate(savedInstanceState: Bundle?) { 
        super.onCreate(savedInstanceState) 
    } 
}`
                    } } }
                },
                'res': {}
            }
        }
    };
}
</script>
</body>
</html>
