<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Flutter Project Editor - Netlify</title>

    <!-- CSS CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/theme/eclipse.min.css">

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            direction: rtl;
            background-color: #f9f9f9;
        }
        h2 {
            color: #333;
        }
        #structureText {
            width: 100%;
            height: 150px;
            resize: vertical;
            border: 1px solid #ccc;
            padding: 10px;
            font-family: monospace;
        }
        ul {
            list-style: none;
            padding-right: 20px;
        }
        button {
            padding: 8px 15px;
            margin: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #editorDiv {
            display: none;
            margin-top: 20px;
            background-color: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .CodeMirror {
            border: 1px solid #ccc;
            height: 400px;
            direction: ltr;
        }
        .empty-file {
            color: red;
        }
        #loading {
            display: none;
            color: #007bff;
            font-weight: bold;
            margin-top: 10px;
        }
        #fileTree {
            margin-top: 10px;
        }
        .file-tree-item {
            margin: 5px 0;
        }
        .file-tree-item button {
            background: none;
            color: #007bff;
            border: none;
            padding: 0;
            cursor: pointer;
        }
        .file-tree-item button:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

<h2>Ø¥Ø¯Ø®Ø§Ù„ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù†ØµÙŠØ§Ù‹</h2>
<textarea id="structureText" placeholder="Ø§Ù„ØµÙ‚ Ù‡Ù†Ø§ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù†ØµÙŠ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹..."></textarea><br>
<label><input type="checkbox" id="addAndroidFiles" checked> Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª Android Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</label><br>
<button onclick="createProject()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</button>

<h2>Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h2>
<div id="fileTree"></div>

<h2>ØªØ­Ø±ÙŠØ± Ø§Ù„Ù…Ù„Ù</h2>
<div id="editorDiv">
    <p>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="currentFile"></span></p>
    <textarea id="fileEditor"></textarea><br>
    <button onclick="saveFile()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
</div>

<h2>Ø¶ØºØ· Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h2>
<button onclick="downloadZip()">Ø¥Ù†Ø´Ø§Ø¡ ZIP ÙˆØªØ­Ù…ÙŠÙ„</button>
<button onclick="buildApk()">Ø¥Ù†Ø´Ø§Ø¡ APK ÙˆØªØ­Ù…ÙŠÙ„</button>
<div id="loading">Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù...</div>

<!-- JS Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/clike/clike.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/dart/dart.min.js"></script>

<script>
let project = {};
let currentFile = '';
let editor = CodeMirror.fromTextArea(document.getElementById("fileEditor"), {
    lineNumbers: true,
    mode: "dart",
    theme: "eclipse",
    direction: "ltr"
});

// ==== Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ù† Ø§Ù„Ù†Øµ ====
function createProject() {
    const text = document.getElementById('structureText').value;
    const lines = text.split('\n');
    project = {};
    const stack = [{ obj: project, level: -1 }];

    lines.forEach(line => {
        if (!line.trim()) return;
        const spaces = line.match(/^\s*/)[0].length;
        const name = line.trim();
        while (stack.length && stack[stack.length - 1].level >= spaces) stack.pop();
        const parent = stack[stack.length - 1].obj;
        if (name.endsWith('/') || !name.includes('.')) parent[name.replace(/\/$/, '')] = {};
        else parent[name] = '';
        if (name.endsWith('/') || !name.includes('.')) stack.push({ obj: parent[name.replace(/\/$/, '')], level: spaces });
    });

    // Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª Android Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    if (document.getElementById('addAndroidFiles').checked) {
        addDefaultAndroidFiles();
        alert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ android Ù…Ø¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡.\nâš ï¸ ØªØ°ÙƒØ±: ØªØ­ØªØ§Ø¬ Ù„Ø¥Ø¶Ø§ÙØ© gradle-wrapper.jar ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø¯Ø§Ø®Ù„ android/gradle/wrapper/ Ù…Ù† https://services.gradle.org/");
    } else {
        alert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­!");
    }

    renderTree();
}

// ==== Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¬Ø±Ø© Ù…Ø¹ ØªÙ…ÙŠÙŠØ² Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙØ§Ø±ØºØ© ====
function renderTree() {
    const container = document.getElementById('fileTree');
    container.innerHTML = '';
    function buildTree(obj, path = '') {
        const ul = document.createElement('ul');
        for (const key in obj) {
            const li = document.createElement('li');
            li.classList.add('file-tree-item');
            const fullPath = path + key;
            if (typeof obj[key] === 'object') {
                const subUl = buildTree(obj[key], fullPath + '/');
                if (subUl.children.length === 0) li.classList.add('empty-file');
                li.innerHTML = `<strong>${key}/</strong>`;
                li.appendChild(subUl);
            } else {
                const btn = document.createElement('button');
                btn.textContent = key;
                if (obj[key].trim() === '') btn.style.color = 'red';
                btn.onclick = () => openFile(fullPath);
                li.appendChild(btn);
            }
            ul.appendChild(li);
        }
        return ul;
    }
    container.appendChild(buildTree(project));
}

// ==== ÙØªØ­ Ø§Ù„Ù…Ù„Ù ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ø± ====
function openFile(path) {
    currentFile = path;
    document.getElementById('editorDiv').style.display = 'block';
    document.getElementById('currentFile').textContent = path;

    const parts = path.split('/');
    let obj = project;
    for (let i = 0; i < parts.length; i++) obj = obj[parts[i]];

    editor.setValue(obj || '');
    if (path.endsWith('.kt')) editor.setOption('mode', 'text/x-kotlin');
    else if (path.endsWith('.dart')) editor.setOption('mode', 'dart');
    else if (path.endsWith('.xml')) editor.setOption('mode', 'xml');
    else if (path.endsWith('.gradle')) editor.setOption('mode', 'groovy');
    else editor.setOption('mode', 'javascript');
}

// ==== Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù ====
function saveFile() {
    const parts = currentFile.split('/');
    let obj = project;
    for (let i = 0; i < parts.length - 1; i++) obj = obj[parts[i]];
    obj[parts[parts.length - 1]] = editor.getValue();
    alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª!');
    renderTree();
}

// ==== ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ù‚Ø¨Ù„ ZIP ====
function updateAllFilesInProject(obj, path = '') {
    for (const key in obj) {
        if (typeof obj[key] === 'object') {
            updateAllFilesInProject(obj[key], path + key + '/');
        } else {
            if (currentFile === path + key) {
                obj[key] = editor.getValue();
            }
        }
    }
}

// ==== Ø¥Ù†Ø´Ø§Ø¡ ZIP Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª ====
function downloadZip() {
    try {
        updateAllFilesInProject(project);
        const zip = new JSZip();

        function addFiles(obj, folder) {
            for (const key in obj) {
                if (typeof obj[key] === 'object') {
                    const sub = folder.folder(key);
                    addFiles(obj[key], sub);
                } else {
                    folder.file(key, obj[key] || '');
                }
            }
        }

        addFiles(project, zip);
        document.getElementById('loading').style.display = 'block';

        zip.generateAsync({ type: "blob" }).then(function (content) {
            const a = document.createElement('a');
            const url = URL.createObjectURL(content);
            a.href = url;
            a.download = "project.zip";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            document.getElementById('loading').style.display = 'none';
            alert('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ZIP ÙˆØªØ­Ù…ÙŠÙ„Ù‡ Ø¨Ù†Ø¬Ø§Ø­!');
        }).catch(function (error) {
            console.error('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ ZIP:', error);
            alert('âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ZIP. ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„.');
            document.getElementById('loading').style.display = 'none';
        });
    } catch (error) {
        console.error('Ø®Ø·Ø£ Ø¹Ø§Ù…:', error);
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶ØºÙˆØ·. ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ­Ø¯Ø© Ø§Ù„ØªØ­ÙƒÙ….');
        document.getElementById('loading').style.display = 'none';
    }
}

// ==== Ø¥Ù†Ø´Ø§Ø¡ APK (ØªÙˆØ¬ÙŠÙ‡ ÙŠØ¯ÙˆÙŠ Ø£Ùˆ Ø¹Ø¨Ø± API Ù„Ø§Ø­Ù‚Ù‹Ø§) ====
function buildApk() {
    alert('âš ï¸ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù APK ÙŠØªØ·Ù„Ø¨ Ø¨ÙŠØ¦Ø© Flutter SDK ÙˆAndroid SDK. Ø§ØªØ¨Ø¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:\n1. Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø¥Ù†Ø´Ø§Ø¡ ZIP ÙˆØªØ­Ù…ÙŠÙ„" Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.\n2. ÙÙƒ Ø¶ØºØ· Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.\n3. ØªØ£ÙƒØ¯ Ù…Ù† ØªØ«Ø¨ÙŠØª Flutter SDK ÙˆAndroid SDK.\n4. Ø§ÙØªØ­ Ø·Ø±ÙÙŠØ© ÙÙŠ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆØ´ØºÙ‘Ù„ Ø§Ù„Ø£Ù…Ø±:\n   flutter build apk --release\nØ³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ APK ÙÙŠ build/app/outputs/flutter-apk/app-release.apk\n\nğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ ÙƒÙ†Øª Ø¨Ø­Ø§Ø¬Ø© Ø¥Ù„Ù‰ Ø¯Ø¹Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø¥Ù†Ø´Ø§Ø¡ APKØŒ ÙŠØ¬Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯ Ø®Ø§Ø¯Ù… Ù…Ø¹ API.');
}

// ==== Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª Android Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© + gradlew ====
function addDefaultAndroidFiles() {
    if (!project['android']) project['android'] = {};

    let projectName = "MyFlutterApp";
    const rootKeys = Object.keys(project);
    if (rootKeys.length > 0) projectName = rootKeys[0];

    const packageName = "com.example." + projectName.toLowerCase();

    project['android']['build.gradle'] = 
`buildscript {
    repositories { google(); mavenCentral() }
    dependencies { classpath 'com.android.tools.build:gradle:7.4.2' }
}
allprojects { repositories { google(); mavenCentral() } }`;

    project['android']['settings.gradle'] = 
`pluginManagement {
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}
rootProject.name = '${projectName}'
include ':app'`;

    project['android']['gradle'] = { 'wrapper': {
        'gradle-wrapper.properties':
`distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\\://services.gradle.org/distributions/gradle-7.5-bin.zip
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists`,
        'gradle-wrapper.jar': '' // ÙŠØ­ØªØ§Ø¬ ØªÙ†Ø²ÙŠÙ„ ÙŠØ¯ÙˆÙŠ
    } };

    project['android']['gradlew'] =
`#!/usr/bin/env sh
DIR="$( cd "$( dirname "$0" )" && pwd )"
exec "$DIR/gradle/wrapper/gradle-wrapper.jar" "$@"`;

    project['android']['gradlew.bat'] =
`@ECHO OFF
SET DIR=%~dp0
"%DIR%\\gradle\\wrapper\\gradle-wrapper.jar" %*`;

    project['android']['app'] = {
        'build.gradle':
`apply plugin: 'com.android.application'

android {
    compileSdkVersion 33
    defaultConfig {
        applicationId "${packageName}"
        minSdkVersion 21
        targetSdkVersion 33
        versionCode 1
        versionName "1.0"
    }
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }
}
dependencies {
    implementation 'androidx.core:core:1.9.0'
}`,
        'src': {
            'main': {
                'AndroidManifest.xml':
`<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="${packageName}">
    <application
        android:label="${projectName}"
        android:icon="@mipmap/ic_launcher">
        <activity
            android:name=".MainActivity"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>
    </application>
</manifest>`,
                'java': {
                    'com': { 'example': { [projectName.toLowerCase()]: {
                        'MainActivity.kt':
`package ${packageName}
import io.flutter.embedding.android.FlutterActivity

class MainActivity: FlutterActivity() {
}`
                    } } }
                },
                'res': {
                    'mipmap': {
                        'ic_launcher.png': '' // ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¶Ø§ÙØ© Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§
                    }
                }
            }
        }
    };

    // Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù pubspec.yaml Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
    if (!project['pubspec.yaml']) {
        project['pubspec.yaml'] =
`name: ${projectName.toLowerCase()}
description: A new Flutter project.
version: 1.0.0+1
environment:
  sdk: '>=2.18.0 <3.0.0'
dependencies:
  flutter:
    sdk: flutter
flutter:
  uses-material-design: true
`;
    }

    // Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù main.dart Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
    if (!project['lib']) project['lib'] = {};
    if (!project['lib']['main.dart']) {
        project['lib']['main.dart'] =
`import 'package:flutter/material.dart';

void main() {
  runApp(MyApp());
}

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: '${projectName}',
      home: Scaffold(
        appBar: AppBar(title: Text('${projectName}')),
        body: Center(child: Text('Hello, Flutter!')),
      ),
    );
  }
}
`;
    }
}
</script>
</body>
</html>
