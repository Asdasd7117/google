<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>نوافذ بحث عبر البروكسي</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; background: #f5f7fb; }
header { position: sticky; top: 0; background: #fff; padding: 8px 12px; box-shadow: 0 2px 10px rgba(0,0,0,.06); z-index: 10; }
h1 { margin: 0; font-size: 16px; }
.controls { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
input[type="text"] { flex: 1; min-width: 180px; padding: 6px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; }
button { padding: 6px 10px; border: 0; border-radius: 8px; cursor: pointer; font-size: 12px; box-shadow: 0 2px 6px rgba(0,0,0,.08); }
.btn { background: #4caf50; color: #fff; }
.btn:hover { filter: brightness(0.95); }
.grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 8px; }
.card { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,.06); display: flex; flex-direction: column; }
.card-header { padding: 4px 6px; display: flex; gap: 4px; align-items: center; border-bottom: 1px solid #eee; }
.card-header input { flex: 1; min-width: 80px; font-size: 12px; padding: 4px; }
.card-header button { font-size: 12px; padding: 4px 8px; }
iframe { width: 100%; height: 250px; border: 0; }
.empty { text-align: center; color: #777; padding: 20px 0; }
</style>
</head>
<body>
<header>
<h1>نوافذ بحث عبر البروكسي</h1>
<div class="controls">
<input id="globalQuery" type="text" placeholder="ابحث هنا أو ضع رابط">
<button class="btn" id="addWindow">فتح نافذة جديدة</button>
<div id="count" style="margin-inline-start:auto;color:#555;">عدد النوافذ: <b id="cnum">0</b></div>
</div>
</header>

<main>
<div class="grid" id="grid"></div>
<div class="empty" id="empty">لا توجد نوافذ بعد. اكتب كلمة بحث أو رابط واضغط "فتح نافذة جديدة".</div>
</main>

<script>
const grid = document.getElementById('grid');
const counter = document.getElementById('cnum');
const empty = document.getElementById('empty');
const globalQuery = document.getElementById('globalQuery');
const addBtn = document.getElementById('addWindow');

let windows = [];

function updateCount() {
    counter.textContent = windows.length;
    empty.style.display = windows.length ? 'none' : 'block';
}

function createCard(query, index) {
    const card = document.createElement('div');
    card.className = 'card';

    const head = document.createElement('div');
    head.className = 'card-header';

    const input = document.createElement('input');
    input.type = 'text';
    input.value = query;
    input.placeholder = 'ابحث داخل هذه النافذة أو ضع رابط...';

    const go = document.createElement('button');
    go.textContent = 'بحث';
    go.style.background = '#2196f3';
    go.style.color = 'white';

    const close = document.createElement('button');
    close.textContent = 'إغلاق';
    close.style.background = '#f44336';
    close.style.color = 'white';

    const frame = document.createElement('iframe');
    frame.loading = 'lazy';

    function load(q) {
        let url;
        if (!q) url = 'https://duckduckgo.com/';
        else if (/^https?:\/\//i.test(q)) url = q;
        else url = `https://duckduckgo.com/?q=${encodeURIComponent(q)}&ia=web`;
        frame.src = `/proxy?url=${encodeURIComponent(url)}`;
    }

    go.addEventListener('click', () => {
        input.value = input.value.trim();
        load(input.value);
    });

    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); go.click(); }
    });

    close.addEventListener('click', async () => {
        await fetch('/remove_window', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ index })
        });
        windows.splice(index,1);
        renderWindows();
    });

    head.append(input, go, close);
    card.append(head, frame);
    load(query);
    return card;
}

function renderWindows() {
    grid.innerHTML = '';
    windows.forEach((w, i) => {
        grid.append(createCard(w,i));
    });
    updateCount();
}

addBtn.addEventListener('click', async () => {
    const query = globalQuery.value.trim();
    if (!query) return;
    await fetch('/add_window', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
    });
    windows.push(query);
    globalQuery.value = '';
    globalQuery.focus();
    renderWindows();
});

// نافذة افتراضية عند التحميل
renderWindows();
</script>
</body>
</html>
